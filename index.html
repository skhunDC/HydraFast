<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#00b4d8">
  <link rel="manifest" href="?resource=manifest">
  <title>HydraFast</title>
  <style>
    :root {
      --primary: #00b4d8;
      --primary-dark: #0077b6;
      --accent: #ff7b54;
      --surface: #ffffff;
      --background: #f0f9ff;
      --text: #1f2933;
      --muted: #64748b;
      --success: #2dd4bf;
      --radius: 18px;
      --shadow: 0 15px 40px rgba(15, 94, 156, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0 0 48px;
      background: linear-gradient(180deg, #e0f6ff 0%, var(--background) 60%);
      color: var(--text);
      text-align: center;
    }

    header {
      padding: 24px 20px 16px;
    }

    h1 {
      margin: 0;
      font-size: 2.2rem;
      color: var(--primary-dark);
      letter-spacing: 1px;
    }

    h2 {
      margin: 0 0 8px;
      font-size: 1.2rem;
      color: var(--primary-dark);
    }

    main {
      padding: 0 20px 40px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 460px;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: left;
    }

    .card.center {
      text-align: center;
    }

    .progress-ring {
      --progress: 0;
      width: 220px;
      height: 220px;
      margin: 0 auto 12px;
      border-radius: 50%;
      background: conic-gradient(var(--primary) calc(var(--progress) * 1%), #d9ecff 0);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.6s ease;
    }

    .progress-inner {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: var(--surface);
      box-shadow: inset 0 6px 18px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      gap: 6px;
    }

    .elapsed-time {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .phase-label {
      font-size: 1rem;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .phase-description {
      margin-top: 8px;
      font-size: 1rem;
      color: var(--muted);
      text-align: center;
    }

    .button-group {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    button {
      font-size: 1rem;
      font-weight: 600;
      padding: 14px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 12px 24px rgba(0, 180, 216, 0.25);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: progress;
    }

    .btn-secondary {
      background: #e2f2ff;
      color: var(--primary-dark);
    }

    .btn-accent {
      background: var(--accent);
      color: white;
      box-shadow: 0 12px 24px rgba(255, 123, 84, 0.25);
    }

    .status-banner {
      margin: 0 auto 12px;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(0, 180, 216, 0.12);
      color: var(--primary-dark);
      font-weight: 600;
      text-align: center;
    }

    .motivation-card {
      background: linear-gradient(135deg, rgba(0, 180, 216, 0.12), rgba(45, 212, 191, 0.25));
      color: var(--primary-dark);
    }

    .motivation-card p {
      margin: 0;
      font-size: 1.05rem;
      line-height: 1.5;
    }

    .mission-card {
      background: linear-gradient(160deg, rgba(0, 180, 216, 0.18), rgba(45, 212, 191, 0.12));
      color: var(--primary-dark);
    }

    .social-card {
      background: linear-gradient(160deg, rgba(0, 180, 216, 0.15), rgba(45, 212, 191, 0.18));
      color: var(--primary-dark);
    }

    .circle-tools {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 12px;
    }

    .circle-tools .helper-text {
      margin: 0;
      flex: 1 1 auto;
    }

    .circle-share {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .share-code {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 8px 14px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--primary-dark);
      box-shadow: 0 6px 16px rgba(0, 119, 182, 0.15);
    }

    .circle-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 20px;
    }

    .circle-member {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0, 119, 182, 0.18);
      border: 1px solid rgba(0, 119, 182, 0.12);
    }

    .circle-member.member-self {
      background: rgba(45, 212, 191, 0.18);
      border-color: rgba(45, 212, 191, 0.45);
    }

    .member-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .member-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      box-shadow: inset 0 4px 12px rgba(255, 255, 255, 0.25);
      text-transform: uppercase;
    }

    .member-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .member-name {
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-pill {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 180, 216, 0.15);
      color: var(--primary-dark);
    }

    .status-pill.status-paused {
      background: rgba(255, 123, 84, 0.18);
      color: var(--accent);
    }

    .status-pill.status-planning {
      background: rgba(45, 212, 191, 0.22);
      color: var(--primary-dark);
    }

    .member-note {
      font-size: 0.88rem;
      color: var(--muted);
    }

    .member-actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      background: rgba(0, 180, 216, 0.18);
      color: var(--primary-dark);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 6px 14px rgba(0, 119, 182, 0.16);
    }

    .chip:active {
      transform: scale(0.97);
    }

    .chip.outline {
      background: transparent;
      border: 1px solid rgba(0, 119, 182, 0.35);
    }

    .chip.ghost {
      background: rgba(255, 255, 255, 0.6);
      border: 1px dashed rgba(0, 119, 182, 0.35);
      color: var(--muted);
    }

    .member-response {
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--primary-dark);
      background: rgba(0, 180, 216, 0.08);
      padding: 10px 12px;
      border-radius: 12px;
    }

    .member-response.pending {
      color: var(--accent);
      background: rgba(255, 123, 84, 0.12);
    }

    .self-note {
      margin-top: 12px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .circle-empty {
      background: rgba(255, 255, 255, 0.6);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 0.9rem;
      color: var(--muted);
      border: 1px dashed rgba(0, 119, 182, 0.25);
    }

    .activity-feed {
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid rgba(0, 119, 182, 0.18);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .activity-feed h3 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--primary-dark);
    }

    .activity-item {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 0.88rem;
    }

    .activity-item strong {
      color: var(--primary-dark);
    }

    .activity-time {
      font-size: 0.75rem;
      color: var(--muted);
      white-space: nowrap;
    }

    @media (max-width: 420px) {
      .activity-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .circle-share {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .milestone-track {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 6px 0 4px;
      scroll-snap-type: x mandatory;
    }

    .milestone-track::-webkit-scrollbar {
      height: 6px;
    }

    .milestone-track::-webkit-scrollbar-thumb {
      background: rgba(0, 119, 182, 0.35);
      border-radius: 6px;
    }

    .milestone-card {
      min-width: 180px;
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 10px 26px rgba(0, 119, 182, 0.18);
      scroll-snap-align: start;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .milestone-card .badge {
      align-self: flex-start;
      background: rgba(0, 180, 216, 0.15);
      color: var(--primary-dark);
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    .milestone-card h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--primary-dark);
    }

    .milestone-card p {
      margin: 0;
      font-size: 0.92rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .milestone-card .reward {
      margin-top: auto;
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 600;
    }

    .milestone-card.achieved {
      background: rgba(45, 212, 191, 0.2);
      box-shadow: 0 14px 28px rgba(45, 212, 191, 0.25);
    }

    .milestone-card.active {
      transform: translateY(-6px);
      box-shadow: 0 16px 32px rgba(0, 119, 182, 0.28);
      border: 1px solid rgba(0, 119, 182, 0.35);
    }

    .hydration-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .hydration-list strong {
      color: var(--primary-dark);
    }

    label {
      font-size: 0.9rem;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input[type="datetime-local"] {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #cfe6ff;
      font-size: 1rem;
      background: #f8fcff;
      color: var(--text);
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #cfe6ff;
      font-size: 1rem;
      background: #f8fcff;
      color: var(--text);
    }

    .helper-text {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .start-input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .start-input-group button {
      width: 100%;
    }

    .start-footnote {
      margin-top: 12px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .timeline-phase {
      border-radius: 14px;
      padding: 14px 16px;
      background: #f6fbff;
      border: 1px solid transparent;
      transition: border 0.3s ease, transform 0.3s ease;
    }

    .timeline-phase.active {
      border-color: var(--primary);
      transform: translateX(4px);
      background: rgba(0, 180, 216, 0.1);
    }

    .timeline-phase h3 {
      margin: 0 0 4px;
      font-size: 1rem;
      color: var(--primary-dark);
    }

    .timeline-phase .focus {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
      margin-top: 2px;
    }

    .timeline-phase .range {
      font-size: 0.85rem;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .timeline-phase p {
      margin: 8px 0 0;
      color: var(--muted);
      line-height: 1.45;
      font-size: 0.95rem;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100%);
      background: var(--primary-dark);
      color: white;
      padding: 12px 18px;
      border-radius: 999px;
      box-shadow: 0 20px 45px rgba(0, 119, 182, 0.35);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      font-size: 0.95rem;
      z-index: 10;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    footer {
      margin-top: 20px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    @media (min-width: 640px) {
      body {
        background: radial-gradient(circle at top, rgba(0, 180, 216, 0.12), transparent 60%), var(--background);
      }
      header {
        padding-top: 48px;
      }
      main {
        padding-bottom: 60px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>HydraFast</h1>
    <p class="status-banner" id="statusBanner">Loading your fasting status…</p>
  </header>

  <main>
    <section class="card center">
      <div class="progress-ring" id="progressRing">
        <div class="progress-inner">
          <div class="elapsed-time" id="elapsedTime">0h 0m</div>
          <div class="phase-label" id="phaseLabel">Getting ready</div>
        </div>
      </div>
      <div class="phase-description" id="phaseDescription">Tap “Start Fast” to begin tracking.</div>
    </section>

    <section class="card mission-card">
      <h2>Milestone Journey</h2>
      <p class="helper-text" id="milestoneMessage">Start your fast to unlock your first milestone boost.</p>
      <div class="milestone-track" id="milestoneTrack"></div>
    </section>

    <section class="card center">
      <div class="button-group">
        <button class="btn-primary" id="startButton" onclick="handleStart()">Start Fast</button>
        <button class="btn-secondary" id="stopButton" onclick="handleStop()" style="display:none;">Stop Fast</button>
        <button class="btn-accent" id="drinkButton" onclick="handleDrink()">Drink Water</button>
      </div>
    </section>

    <section class="card">
      <h2>Fast Start Time</h2>
      <p class="helper-text">Record the exact moment you began so your fasting phases stay accurate.</p>
      <div class="start-input-group">
        <input type="datetime-local" id="fastStartInput" aria-label="Fast start date and time">
        <button class="btn-secondary" id="setStartTimeButton" onclick="handleSaveStartTime()">Save Start Time</button>
      </div>
      <p class="start-footnote" id="currentStartDisplay">Choose a start time to begin tracking.</p>
    </section>

    <section class="card">
      <h2>Hydration Focus</h2>
      <div class="hydration-list">
        <div><strong>Last drink:</strong> <span id="lastDrink">--</span></div>
        <div><strong>Next reminder:</strong> <span id="nextReminder">--</span></div>
      </div>
      <div style="margin-top:16px;">
        <label for="reminderInterval">Send hydration reminder every</label>
        <select id="reminderInterval" onchange="handleReminderChange(this.value)">
          <option value="30">30 minutes</option>
          <option value="45">45 minutes</option>
          <option value="60">60 minutes</option>
          <option value="90">90 minutes</option>
          <option value="120">120 minutes</option>
          <option value="180">180 minutes</option>
        </select>
      </div>
    </section>

    <section class="card social-card">
      <div class="circle-tools">
        <div>
          <h2>Circle Sparks</h2>
          <p class="helper-text">Share your fast with friends, send playful waves, and keep each other hydrated.</p>
        </div>
        <div class="circle-share">
          <span class="share-code" id="shareCode">HF-0000</span>
          <button class="chip outline" onclick="handleCopyInvite()" aria-label="Copy invite code">Copy invite</button>
          <button class="chip" onclick="handleCirclePulse()" aria-label="Send a circle pulse">Circle pulse</button>
        </div>
      </div>
      <div class="circle-list" id="circleList"></div>
      <div class="activity-feed" id="circleActivity" aria-live="polite"></div>
    </section>

    <section class="card motivation-card">
      <h2>Daily Motivation</h2>
      <p id="motivationText">Stay hydrated and take the first step.</p>
    </section>

    <section class="card">
      <h2>Fasting Timeline</h2>
      <div class="timeline" id="timeline"></div>
    </section>
  </main>

  <footer>
    Hydrate, breathe, and listen to your body.
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    let currentStatus = null;
    let isLoading = false;
    let refreshTimer = null;
    let circleState = null;

    const circleResponseTimers = {};
    const LOCAL_PROFILE_KEY = 'hydrafast:deviceProfile:v2';
    const LOCAL_CIRCLE_KEY = 'hydrafast:circle:v1';
    const DEFAULT_REMINDER_MINUTES = 120;
    const PROGRESS_TARGET_HOURS = 72;
    const CIRCLE_RESPONSE_DELAY = { min: 3200, max: 6400 };
    const MILESTONES = [
      {
        hours: 0,
        title: 'Launch Ritual',
        benefit: 'Clarify your goal and prime your hydration strategy.',
        reward: 'Mindset locked in and ready.'
      },
      {
        hours: 4,
        title: 'Metabolic Reset',
        benefit: 'Blood sugar balances and cravings calm.',
        reward: 'Focus feels smoother.'
      },
      {
        hours: 8,
        title: 'Fat Mobilizer',
        benefit: 'Your body leans on stored fuel for energy.',
        reward: 'Energy feels lighter and steadier.'
      },
      {
        hours: 12,
        title: 'Cellular Cleanse',
        benefit: 'Autophagy sparks gentle cellular clean-up.',
        reward: 'Mental clarity begins to bloom.'
      },
      {
        hours: 16,
        title: 'Ketone Glow',
        benefit: 'Ketones support calm, clear thinking.',
        reward: 'Mood steadies with purposeful energy.'
      },
      {
        hours: 20,
        title: 'Repair Momentum',
        benefit: 'Growth hormone rises to protect lean muscle.',
        reward: 'Body rebuilds with confidence.'
      },
      {
        hours: 24,
        title: 'Immune Refresh',
        benefit: 'Immune rejuvenation and inflammation reset activate.',
        reward: 'Resilience shines from within.'
      },
      {
        hours: 36,
        title: 'Heroic Harmony',
        benefit: 'Deep autophagy sweeps cells clean.',
        reward: 'Whole-body harmony unlocked.'
      }
    ];

    const LOCAL_TIMELINE = [
      {
        key: 'launch',
        title: 'Launch Ritual',
        range: '0-2h',
        startHours: 0,
        endHours: 2,
        description: 'Your body is finishing digestion. Lock in your intention and sip water mindfully.',
        focus: 'Set your goal and design your hydration rhythm.'
      },
      {
        key: 'balance',
        title: 'Balance Builder',
        range: '2-6h',
        startHours: 2,
        endHours: 6,
        description: 'Blood sugar steadies and cravings soften as insulin begins to dip.',
        focus: 'Enjoy steady breathing and light stretching between sips.'
      },
      {
        key: 'reset',
        title: 'Metabolic Reset',
        range: '6-10h',
        startHours: 6,
        endHours: 10,
        description: 'Your body transitions toward fat for fuel while hydration supports detox pathways.',
        focus: 'Keep water flowing and celebrate the calm energy arriving.'
      },
      {
        key: 'shift',
        title: 'Fat Fuel Shift',
        range: '10-16h',
        startHours: 10,
        endHours: 16,
        description: 'Fat burning accelerates and cellular cleanup begins to spark.',
        focus: 'Take a mindful walk or stretch to enjoy the momentum.'
      },
      {
        key: 'repair',
        title: 'Repair Revival',
        range: '16-24h',
        startHours: 16,
        endHours: 24,
        description: 'Ketones rise to fuel your brain while autophagy works on cellular repair.',
        focus: 'Breathe deeply and honor each signal your body sends.'
      },
      {
        key: 'renewal',
        title: 'Renewal Wave',
        range: '24-36h',
        startHours: 24,
        endHours: 36,
        description: 'Immune rejuvenation intensifies and inflammation begins to ease.',
        focus: 'Hydrate with electrolytes and rest intentionally.'
      },
      {
        key: 'harmony',
        title: 'Harmony Horizon',
        range: '36-48h',
        startHours: 36,
        endHours: 48,
        description: 'Deep cellular refresh brings harmony through every system.',
        focus: 'Move gently and celebrate how far you have come.'
      },
      {
        key: 'clarity',
        title: 'Deep Clarity',
        range: '48-72h',
        startHours: 48,
        endHours: 72,
        description: 'Recovery hormones peak and your body preserves lean muscle.',
        focus: 'Prioritize calm, sleep, and gratitude for your effort.'
      },
      {
        key: 'legacy',
        title: 'Legacy Glow',
        range: '72h+',
        startHours: 72,
        endHours: null,
        description: 'You have mastered your rhythm—pause with your health professional before extending further.',
        focus: 'Reflect, refeed slowly, and note insights for your next journey.'
      }
    ];

    const CIRCLE_RESPONSE_GENERATORS = [
      function (member) {
        return {
          status: 'fasting',
          message: member.name + ' is still fasting and just finished a mindful sip.',
          activity: 'checked in and is still fasting 💪',
          toast: member.name + ' is locked in!',
          hydrationMinutes: 5,
          hoursDelta: 1
        };
      },
      function (member) {
        return {
          status: 'fasting',
          message: member.name + ' says: “Still flowing—headed to refill my bottle!”',
          activity: 'promised a hydration refill.',
          toast: 'Hydration wave reached ' + member.name + '.',
          hydrationMinutes: 2,
          hoursDelta: 0.5
        };
      },
      function (member) {
        return {
          status: 'planning',
          message: member.name + ' paused to reset—cheer them on for the next round.',
          activity: 'is regrouping for a fresh start.',
          toast: member.name + ' is regrouping.',
          hydrationMinutes: 60,
          hoursDelta: 0
        };
      },
      function (member) {
        return {
          status: 'paused',
          message: member.name + ' lost track and asked for a reminder—send a caring wave.',
          activity: 'requested a gentle reminder.',
          toast: member.name + ' needs a gentle reminder.',
          hydrationMinutes: 90,
          hoursDelta: 0
        };
      }
    ];

    document.addEventListener('DOMContentLoaded', function () {
      initializeMilestones();
      initializeCircle();
      const localStatus = calculateLocalStatus();
      if (localStatus) {
        renderStatus(localStatus);
      }
      refreshStatus();
      refreshTimer = setInterval(refreshStatus, 60000);
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('?resource=service-worker', { scope: './' }).catch(function () {
          // ignore failures silently
        });
      }
    });

    function refreshStatus() {
      if (isLoading) {
        return;
      }
      isLoading = true;
      if (!hasAppsScript()) {
        isLoading = false;
        const localStatus = calculateLocalStatus();
        if (localStatus) {
          currentStatus = localStatus;
          renderStatus(localStatus);
        } else {
          document.getElementById('statusBanner').textContent = 'HydraFast is ready on this device. Tap “Start Fast” to begin your journey.';
        }
        return;
      }
      google.script.run
        .withSuccessHandler(function (response) {
          isLoading = false;
          currentStatus = response;
          renderStatus(response);
        })
        .withFailureHandler(function (err) {
          isLoading = false;
          showToast('Unable to refresh status. Please try again.');
          console.error(err);
        })
        .getStatus();
    }

    function handleStart() {
      let timestamp = null;
      const input = document.getElementById('fastStartInput');
      if (input && input.value) {
        const parsed = Date.parse(input.value);
        if (isNaN(parsed)) {
          showToast('Start time is not valid.');
          return;
        }
        if (parsed > Date.now()) {
          showToast('Start time cannot be in the future.');
          return;
        }
        timestamp = parsed;
      }
      if (!hasAppsScript()) {
        const status = startLocalFast(timestamp || Date.now());
        if (status) {
          renderStatus(status);
        }
        showToast('Fast started on this device. Hydrate with intention!');
        return;
      }
      setButtonsDisabled(true);
      google.script.run
        .withSuccessHandler(function (response) {
          currentStatus = response;
          renderStatus(response);
          showToast('Fast started! Stay hydrated.');
          setButtonsDisabled(false);
        })
        .withFailureHandler(function (err) {
          showToast('Could not start fast. Please try again.');
          console.error(err);
          setButtonsDisabled(false);
        })
        .startFast(timestamp);
    }

    function handleStop() {
      if (!hasAppsScript()) {
        const status = stopLocalFast();
        if (status) {
          renderStatus(status);
        }
        showToast('Fast ended for this device. Great listening.');
        return;
      }
      setButtonsDisabled(true);
      google.script.run
        .withSuccessHandler(function (response) {
          currentStatus = response;
          renderStatus(response);
          showToast('Fast stopped. Reflect on your progress.');
          setButtonsDisabled(false);
        })
        .withFailureHandler(function (err) {
          showToast('Could not stop fast. Please try again.');
          console.error(err);
          setButtonsDisabled(false);
        })
        .stopFast();
    }

    function handleDrink() {
      if (!hasAppsScript()) {
        const status = recordLocalDrink();
        if (status) {
          renderStatus(status);
        }
        showToast('Hydration logged. Keep the flow going!');
        return;
      }
      setButtonsDisabled(true);
      google.script.run
        .withSuccessHandler(function (response) {
          currentStatus = response;
          renderStatus(response);
          showToast('Logged a hydration break.');
          setButtonsDisabled(false);
        })
        .withFailureHandler(function (err) {
          showToast('Could not log hydration.');
          console.error(err);
          setButtonsDisabled(false);
        })
        .recordHydration();
    }

    function handleReminderChange(value) {
      if (!hasAppsScript()) {
        const status = setLocalReminderInterval(Number(value));
        if (status) {
          renderStatus(status);
        }
        showToast('Hydration reminders updated for this device.');
        return;
      }
      google.script.run
        .withSuccessHandler(function (response) {
          currentStatus = response;
          renderStatus(response);
          showToast('Hydration reminders updated.');
        })
        .withFailureHandler(function (err) {
          showToast('Unable to update reminders.');
          console.error(err);
        })
        .setReminderInterval(value);
    }

    function handleSaveStartTime() {
      const input = document.getElementById('fastStartInput');
      if (!input || !input.value) {
        showToast('Choose a start date and time first.');
        return;
      }
      const timestamp = Date.parse(input.value);
      if (isNaN(timestamp)) {
        showToast('Start time is not valid.');
        return;
      }
      if (timestamp > Date.now()) {
        showToast('Start time cannot be in the future.');
        return;
      }
      if (!hasAppsScript()) {
        const status = setLocalStartTime(timestamp);
        if (status) {
          renderStatus(status);
        }
        showToast('Start time saved for this device.');
        return;
      }
      setButtonsDisabled(true);
      google.script.run
        .withSuccessHandler(function (response) {
          currentStatus = response;
          renderStatus(response);
          showToast('Start time saved. Your fast is now aligned.');
          setButtonsDisabled(false);
        })
        .withFailureHandler(function (err) {
          showToast('Could not save start time. Please try again.');
          console.error(err);
          setButtonsDisabled(false);
        })
        .setFastStart(timestamp);
    }

    function renderStatus(status) {
      const startButton = document.getElementById('startButton');
      const stopButton = document.getElementById('stopButton');
      const progressRing = document.getElementById('progressRing');
      const elapsedTime = document.getElementById('elapsedTime');
      const phaseLabel = document.getElementById('phaseLabel');
      const phaseDescription = document.getElementById('phaseDescription');
      const statusBanner = document.getElementById('statusBanner');
      const reminderSelect = document.getElementById('reminderInterval');

      const isFasting = status.status === 'fasting';
      startButton.style.display = isFasting ? 'none' : 'block';
      stopButton.style.display = isFasting ? 'block' : 'none';

      const elapsedLabel = isFasting ? status.elapsedLabel : '0h 0m';
      elapsedTime.textContent = elapsedLabel;
      const activePhase = status.phaseDetails;
      phaseLabel.textContent = isFasting && activePhase ? activePhase.title : 'Ready to begin';
      phaseDescription.textContent = isFasting && activePhase ? activePhase.description : 'Tap “Start Fast” to begin tracking.';

      const progress = isFasting ? status.progressPercent : 0;
      progressRing.style.setProperty('--progress', progress);

      if (isFasting && activePhase) {
        statusBanner.textContent = 'You are in ' + activePhase.title + ' • ' + activePhase.range + '. Stay hydrated!';
      } else {
        statusBanner.textContent = 'Press “Start Fast” to begin your hydration-focused fast.';
      }

      const intervalValue = String(status.hydration.intervalMinutes);
      ensureReminderOption(reminderSelect, intervalValue);
      reminderSelect.value = intervalValue;
      updateStartInputs(status);
      updateHydration(status.hydration, isFasting);
      updateMotivation(status.motivationalMessage);
      updateTimeline(status.timeline, status.activePhaseIndex);
      persistLocalProfileFromStatus(status);
      updateMilestones(status);
      celebrateMilestones(status);
      syncCircleWithStatus(status);
    }

    function updateStartInputs(status) {
      const input = document.getElementById('fastStartInput');
      const display = document.getElementById('currentStartDisplay');
      if (!input || !display) {
        return;
      }
      if (status.startTimestamp) {
        input.value = formatDateTimeLocal(status.startTimestamp);
        display.textContent = 'Tracking since ' + formatExactDateTime(status.startTimestamp) + '.';
      } else {
        input.value = formatDateTimeLocal(Date.now());
        display.textContent = 'Choose a start time to begin tracking.';
      }
    }

    function updateHydration(hydration, isFasting) {
      const lastDrinkEl = document.getElementById('lastDrink');
      const nextReminderEl = document.getElementById('nextReminder');

      if (!hydration.lastDrinkTimestamp) {
        lastDrinkEl.textContent = isFasting ? 'Just getting started' : 'Log a drink when you begin fasting';
      } else {
        lastDrinkEl.textContent = formatRelativeTime(hydration.lastDrinkTimestamp);
      }

      if (hydration.nextReminderMinutes === null || hydration.nextReminderMinutes === undefined) {
        nextReminderEl.textContent = isFasting ? 'Reminders will begin soon' : 'Start fasting to activate reminders';
      } else if (hydration.nextReminderMinutes === 0) {
        nextReminderEl.textContent = 'Reminder due now';
      } else {
        nextReminderEl.textContent = 'In ' + formatMinutes(hydration.nextReminderMinutes);
      }
    }

    function updateMotivation(message) {
      const motivationEl = document.getElementById('motivationText');
      motivationEl.textContent = message || 'Hydrate and listen to your body.';
    }

    function updateTimeline(timeline, activeIndex) {
      const container = document.getElementById('timeline');
      container.innerHTML = '';
      if (!timeline || !Array.isArray(timeline)) {
        return;
      }
      timeline.forEach(function (phase, index) {
        const wrapper = document.createElement('div');
        wrapper.className = 'timeline-phase' + (index === activeIndex ? ' active' : '');
        const title = document.createElement('h3');
        title.textContent = phase.title;
        const range = document.createElement('div');
        range.className = 'range';
        range.textContent = phase.range;
        const focus = document.createElement('div');
        focus.className = 'focus';
        focus.textContent = phase.focus || '';
        const description = document.createElement('p');
        description.textContent = phase.description;
        wrapper.appendChild(range);
        wrapper.appendChild(title);
        if (phase.focus) {
          wrapper.appendChild(focus);
        }
        wrapper.appendChild(description);
        container.appendChild(wrapper);
      });
    }

    function setButtonsDisabled(disabled) {
      document.getElementById('startButton').disabled = disabled;
      document.getElementById('stopButton').disabled = disabled;
      document.getElementById('drinkButton').disabled = disabled;
      const setStartButton = document.getElementById('setStartTimeButton');
      if (setStartButton) {
        setStartButton.disabled = disabled;
      }
      const fastStartInput = document.getElementById('fastStartInput');
      if (fastStartInput) {
        fastStartInput.disabled = disabled;
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(function () {
        toast.classList.remove('show');
      }, 2600);
    }

    function formatRelativeTime(timestamp) {
      const deltaMinutes = Math.floor((Date.now() - timestamp) / 60000);
      if (deltaMinutes <= 0) {
        return 'Just now';
      }
      if (deltaMinutes < 60) {
        return deltaMinutes + ' min ago';
      }
      const hours = Math.floor(deltaMinutes / 60);
      const minutes = deltaMinutes % 60;
      return hours + 'h ' + minutes + 'm ago';
    }

    function formatMinutes(minutes) {
      if (minutes < 60) {
        return minutes + ' min';
      }
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      if (mins === 0) {
        return hours + ' hr';
      }
      return hours + ' hr ' + mins + ' min';
    }

    function formatMinutesAgo(minutes) {
      if (minutes === null || minutes === undefined) {
        return 'No sip yet';
      }
      const rounded = Math.max(0, Math.round(minutes));
      if (rounded <= 1) {
        return 'just now';
      }
      if (rounded < 60) {
        return rounded + ' min ago';
      }
      const hours = Math.floor(rounded / 60);
      const remainder = rounded % 60;
      if (remainder === 0) {
        return hours + 'h ago';
      }
      return hours + 'h ' + remainder + 'm ago';
    }

    function ensureReminderOption(select, value) {
      let hasOption = false;
      Array.prototype.forEach.call(select.options, function (option) {
        if (option.value === value) {
          hasOption = true;
        }
      });
      if (!hasOption) {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = formatIntervalLabel(Number(value));
        select.appendChild(option);
      }
    }

    function formatIntervalLabel(minutes) {
      if (!minutes || isNaN(minutes)) {
        return 'Custom';
      }
      if (minutes < 60) {
        return minutes + ' minutes';
      }
      const hours = Math.floor(minutes / 60);
      const remainder = minutes % 60;
      if (remainder === 0) {
        return hours + (hours === 1 ? ' hour' : ' hours');
      }
      return hours + 'h ' + remainder + 'm';
    }

    function formatDateTimeLocal(timestamp) {
      if (!timestamp) {
        return '';
      }
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) {
        return '';
      }
      const offsetDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
      return offsetDate.toISOString().slice(0, 16);
    }

    function formatExactDateTime(timestamp) {
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) {
        return '--';
      }
      return date.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
    }

    function initializeMilestones() {
      const track = document.getElementById('milestoneTrack');
      if (!track) {
        return;
      }
      track.innerHTML = '';
      MILESTONES.forEach(function (milestone) {
        const card = document.createElement('div');
        card.className = 'milestone-card';
        card.dataset.hours = milestone.hours;
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = milestone.hours === 0 ? 'Start' : milestone.hours + 'h';
        const title = document.createElement('h3');
        title.textContent = milestone.title;
        const benefit = document.createElement('p');
        benefit.textContent = milestone.benefit;
        const reward = document.createElement('div');
        reward.className = 'reward';
        reward.textContent = milestone.reward;
        card.appendChild(badge);
        card.appendChild(title);
        card.appendChild(benefit);
        card.appendChild(reward);
        track.appendChild(card);
      });
    }

    function updateMilestones(status) {
      const track = document.getElementById('milestoneTrack');
      const messageEl = document.getElementById('milestoneMessage');
      if (!track || !messageEl) {
        return;
      }
      if (!status) {
        messageEl.textContent = 'Start your fast to unlock your first milestone boost.';
        return;
      }
      const hasStarted = Boolean(status.startTimestamp);
      const elapsedHours = status.elapsedHours || 0;
      let nextCard = null;
      Array.prototype.forEach.call(track.children, function (card) {
        const milestoneHours = Number(card.dataset.hours);
        const isZero = milestoneHours === 0;
        card.classList.remove('achieved', 'active');
        const achieved = hasStarted && (isZero || elapsedHours >= milestoneHours);
        if (achieved) {
          card.classList.add('achieved');
        } else if (!nextCard) {
          nextCard = card;
        }
      });
      if (nextCard) {
        nextCard.classList.add('active');
      }
      const nextData = nextCard
        ? MILESTONES.find(function (milestone) {
            return milestone.hours === Number(nextCard.dataset.hours);
          })
        : null;
      if (!hasStarted) {
        messageEl.textContent = 'Tap “Start Fast” to begin and unlock your milestone boosts.';
      } else if (nextData) {
        const deltaHours = Math.max(0, nextData.hours - elapsedHours);
        if (deltaHours <= 0) {
          messageEl.textContent = 'Milestone unlocked: ' + nextData.title + '! ' + nextData.reward;
        } else {
          const deltaMinutes = Math.max(1, Math.round(deltaHours * 60));
          messageEl.textContent = 'Next boost: ' + nextData.title + ' in ' + formatMinutes(deltaMinutes) + '.';
        }
      } else {
        messageEl.textContent = 'You have unlocked every milestone—hydrate, recover, and record how you feel.';
      }
    }

    function celebrateMilestones(status) {
      if (!status || !supportsLocalStorage()) {
        return;
      }
      const profile = getOrCreateLocalProfile();
      if (!status.startTimestamp) {
        if (profile.unlockedMilestones && profile.unlockedMilestones.length) {
          profile.unlockedMilestones = [];
          saveLocalProfile(profile);
        }
        return;
      }
      const elapsedHours = status.elapsedHours || 0;
      const unlocked = Array.isArray(profile.unlockedMilestones) ? profile.unlockedMilestones.slice() : [];
      const newlyUnlocked = MILESTONES.filter(function (milestone) {
        return milestone.hours > 0 && elapsedHours >= milestone.hours && unlocked.indexOf(milestone.hours) === -1;
      });
      if (newlyUnlocked.length === 0) {
        return;
      }
      const latest = newlyUnlocked[newlyUnlocked.length - 1];
      newlyUnlocked.forEach(function (milestone) {
        unlocked.push(milestone.hours);
      });
      profile.unlockedMilestones = Array.from(new Set(unlocked)).sort(function (a, b) {
        return a - b;
      });
      saveLocalProfile(profile);
      showToast('Milestone unlocked: ' + latest.title + '! ' + latest.reward);
    }

    function initializeCircle() {
      ensureCircleState();
      renderCircle();
    }

    function ensureCircleState() {
      if (circleState) {
        return circleState;
      }
      const stored = loadCircle();
      circleState = stored || createDefaultCircle();
      normalizeCircle(circleState);
      saveCircle(circleState);
      return circleState;
    }

    function loadCircle() {
      if (!supportsLocalStorage()) {
        return circleState;
      }
      try {
        const raw = localStorage.getItem(LOCAL_CIRCLE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (err) {
        return null;
      }
    }

    function saveCircle(circle) {
      if (!supportsLocalStorage()) {
        return;
      }
      try {
        localStorage.setItem(LOCAL_CIRCLE_KEY, JSON.stringify(circle));
      } catch (err) {
        // ignore quota or privacy limitations
      }
    }

    function createDefaultCircle() {
      const now = Date.now();
      return {
        shareCode: createShareCode(),
        members: createDefaultMembers(),
        activity: [
          { id: 'act-' + now, message: 'Welcome to Circle Sparks! Invite friends with your code.', timestamp: now - 60000 },
          { id: 'act-' + (now + 1), message: 'Ava celebrated a hydration win at 14h.', timestamp: now - 180000 }
        ]
      };
    }

    function createDefaultMembers() {
      return [
        {
          id: 'you',
          name: 'You',
          initials: 'YOU',
          color: 'linear-gradient(135deg, #00b4d8, #48cae4)',
          status: 'planning',
          hours: 0,
          lastHydrationMinutes: null,
          streak: 0,
          responseMessage: 'Your circle will light up once you start your next fast.',
          checkInState: 'idle'
        },
        {
          id: 'ava',
          name: 'Ava',
          initials: 'A',
          color: 'linear-gradient(135deg, #0077b6, #00b4d8)',
          status: 'fasting',
          hours: 14,
          lastHydrationMinutes: 38,
          streak: 3,
          responseMessage: 'Ava is gliding through Ketone Glow and feeling focused.',
          checkInState: 'idle'
        },
        {
          id: 'marco',
          name: 'Marco',
          initials: 'M',
          color: 'linear-gradient(135deg, #06d6a0, #118ab2)',
          status: 'planning',
          hours: 0,
          lastHydrationMinutes: 75,
          streak: 5,
          responseMessage: 'Marco scheduled a sunset fast—send a wave to lock it in.',
          checkInState: 'idle'
        },
        {
          id: 'zoe',
          name: 'Zoe',
          initials: 'Z',
          color: 'linear-gradient(135deg, #ff7b54, #ffd166)',
          status: 'paused',
          hours: 9,
          lastHydrationMinutes: 120,
          streak: 2,
          responseMessage: 'Zoe paused for a mindful refeed—she’ll restart tonight.',
          checkInState: 'idle'
        }
      ];
    }

    function createShareCode() {
      const randomPart = Math.random().toString(36).slice(-4).toUpperCase();
      const timePart = Date.now().toString().slice(-2);
      return 'HF-' + timePart + randomPart;
    }

    function normalizeCircle(circle) {
      if (!circle.shareCode) {
        circle.shareCode = createShareCode();
      }
      if (!Array.isArray(circle.members) || !circle.members.length) {
        circle.members = createDefaultMembers();
      }
      circle.members = circle.members.map(function (member, index) {
        return normalizeMember(member, index);
      });
      circle.members.sort(function (a, b) {
        if (a.id === 'you') {
          return -1;
        }
        if (b.id === 'you') {
          return 1;
        }
        return a.name.localeCompare(b.name);
      });
      if (!Array.isArray(circle.activity)) {
        circle.activity = [];
      }
      if (circle.activity.length > 25) {
        circle.activity = circle.activity.slice(circle.activity.length - 25);
      }
      return circle;
    }

    function normalizeMember(member, index) {
      const normalized = Object.assign({}, member);
      normalized.id = normalized.id || 'member-' + index;
      normalized.name = normalized.name || 'Friend';
      normalized.initials = normalized.initials || normalized.name.split(' ').map(function (part) {
        return part.charAt(0);
      }).join('').slice(0, 2);
      normalized.color = normalized.color || 'linear-gradient(135deg, #00b4d8, #48cae4)';
      normalized.status = normalized.status || 'planning';
      normalized.hours = typeof normalized.hours === 'number' ? normalized.hours : 0;
      normalized.lastHydrationMinutes = typeof normalized.lastHydrationMinutes === 'number'
        ? Math.max(0, Math.round(normalized.lastHydrationMinutes))
        : null;
      normalized.streak = typeof normalized.streak === 'number' ? Math.max(0, Math.round(normalized.streak)) : 0;
      normalized.responseMessage = normalized.responseMessage || 'Send a wave to say hello.';
      normalized.checkInState = normalized.checkInState || 'idle';
      normalized.nudgeCount = normalized.nudgeCount || 0;
      return normalized;
    }

    function mutateCircle(mutator) {
      const circle = ensureCircleState();
      const result = mutator(circle) || {};
      normalizeCircle(circle);
      circleState = circle;
      saveCircle(circle);
      renderCircle();
      return result;
    }

    function renderCircle() {
      const circle = ensureCircleState();
      const shareEl = document.getElementById('shareCode');
      if (shareEl) {
        shareEl.textContent = circle.shareCode;
      }
      const list = document.getElementById('circleList');
      if (!list) {
        return;
      }
      list.innerHTML = '';
      let friendCount = 0;
      circle.members.forEach(function (member) {
        const card = document.createElement('div');
        card.className = 'circle-member' + (member.id === 'you' ? ' member-self' : '');

        const header = document.createElement('div');
        header.className = 'member-header';

        const avatar = document.createElement('div');
        avatar.className = 'member-avatar';
        avatar.style.background = member.color;
        avatar.textContent = (member.initials || member.name.charAt(0) || '?').slice(0, 2);
        header.appendChild(avatar);

        const meta = document.createElement('div');
        meta.className = 'member-meta';
        const name = document.createElement('div');
        name.className = 'member-name';
        const nameText = document.createElement('span');
        nameText.textContent = member.id === 'you' ? 'You' : member.name;
        const pill = document.createElement('span');
        const statusClass = 'status-pill status-' + (member.status || 'planning');
        pill.className = statusClass.trim();
        pill.textContent = buildStatusLabel(member);
        name.appendChild(nameText);
        name.appendChild(pill);
        const note = document.createElement('div');
        note.className = 'member-note';
        note.textContent = describeMember(member);
        meta.appendChild(name);
        meta.appendChild(note);
        header.appendChild(meta);
        card.appendChild(header);

        const responseText = member.checkInState === 'pending'
          ? 'Waiting for ' + (member.id === 'you' ? 'you' : member.name) + ' to check in…'
          : (member.responseMessage || 'Send a wave to say hi.');
        const response = document.createElement('div');
        response.className = 'member-response' + (member.checkInState === 'pending' ? ' pending' : '');
        response.textContent = responseText;

        if (member.id === 'you') {
          card.appendChild(response);
          const selfNote = document.createElement('div');
          selfNote.className = 'self-note';
          selfNote.textContent = 'Your circle view updates automatically with your fasting timer.';
          card.appendChild(selfNote);
        } else {
          friendCount += 1;
          const actions = document.createElement('div');
          actions.className = 'member-actions';

          const nudgeBtn = document.createElement('button');
          nudgeBtn.type = 'button';
          nudgeBtn.className = 'chip';
          const recentlyNudged = member.lastNudgeAt && (Date.now() - member.lastNudgeAt < 10 * 60 * 1000);
          if (recentlyNudged) {
            nudgeBtn.disabled = true;
            nudgeBtn.classList.add('ghost');
            nudgeBtn.textContent = 'Wave sent';
            nudgeBtn.title = 'You nudged ' + member.name + ' recently.';
          } else {
            nudgeBtn.textContent = 'Send wave';
            nudgeBtn.onclick = function () {
              handleNudgeMember(member.id);
            };
            nudgeBtn.title = 'Give ' + member.name + ' a playful hydration nudge.';
          }

          const checkBtn = document.createElement('button');
          checkBtn.type = 'button';
          checkBtn.className = 'chip outline';
          if (member.checkInState === 'pending') {
            checkBtn.disabled = true;
            checkBtn.classList.add('ghost');
            checkBtn.textContent = 'Pulse sent';
            checkBtn.title = 'Waiting for ' + member.name + ' to reply.';
          } else {
            checkBtn.textContent = 'Pulse check';
            checkBtn.onclick = function () {
              handleCheckInMember(member.id);
            };
            checkBtn.title = 'Ask ' + member.name + ' if they are still fasting.';
          }

          actions.appendChild(nudgeBtn);
          actions.appendChild(checkBtn);
          card.appendChild(actions);
          card.appendChild(response);
        }

        list.appendChild(card);
      });

      if (friendCount === 0) {
        const empty = document.createElement('div');
        empty.className = 'circle-empty';
        empty.textContent = 'Invite a friend with your code to start trading nudges and check-ins.';
        list.appendChild(empty);
      }

      renderCircleActivity();
    }

    function renderCircleActivity() {
      const activityEl = document.getElementById('circleActivity');
      if (!activityEl) {
        return;
      }
      activityEl.innerHTML = '';
      const header = document.createElement('h3');
      header.textContent = 'Latest activity';
      activityEl.appendChild(header);
      const circle = ensureCircleState();
      const items = circle.activity.slice().reverse().slice(0, 5);
      if (!items.length) {
        const empty = document.createElement('div');
        empty.className = 'circle-empty';
        empty.textContent = 'No activity yet. Send a wave to get things flowing.';
        activityEl.appendChild(empty);
        return;
      }
      items.forEach(function (entry) {
        const item = document.createElement('div');
        item.className = 'activity-item';
        const message = document.createElement('span');
        message.textContent = entry.message;
        const time = document.createElement('span');
        time.className = 'activity-time';
        time.textContent = formatRelativeTime(entry.timestamp);
        item.appendChild(message);
        item.appendChild(time);
        activityEl.appendChild(item);
      });
    }

    function buildStatusLabel(member) {
      if (member.status === 'fasting') {
        const hours = Math.max(0, Math.round(member.hours || 0));
        if (hours === 0) {
          return 'Fasting';
        }
        return 'Fasting • ' + hours + 'h';
      }
      if (member.status === 'paused') {
        return 'Paused fast';
      }
      return 'Planning next';
    }

    function describeMember(member) {
      const hydration = formatMemberHydration(member.lastHydrationMinutes);
      const streak = formatStreak(member.streak);
      return hydration + ' • ' + streak;
    }

    function formatMemberHydration(minutes) {
      if (minutes === null || minutes === undefined) {
        return 'No sip logged yet';
      }
      return 'Last sip ' + formatMinutesAgo(minutes);
    }

    function formatStreak(days) {
      if (!days) {
        return 'Streak warming up';
      }
      return days + (days === 1 ? '-day streak' : '-day streak');
    }

    function handleCopyInvite() {
      const circle = ensureCircleState();
      const code = circle.shareCode;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(code).then(function () {
          showToast('Invite code copied!');
        }).catch(function () {
          showToast('Invite code: ' + code);
        });
        return;
      }
      try {
        const tempInput = document.createElement('input');
        tempInput.value = code;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showToast('Invite code copied!');
      } catch (err) {
        showToast('Invite code: ' + code);
      }
    }

    function handleCirclePulse() {
      const circle = ensureCircleState();
      const others = circle.members.filter(function (member) {
        return member.id !== 'you';
      });
      if (!others.length) {
        showToast('Invite a friend to send a pulse.');
        return;
      }
      mutateCircle(function (circle) {
        addCircleActivity(circle, 'You sent a circle pulse to everyone.');
        circle.members.forEach(function (member) {
          if (member.id === 'you') {
            return;
          }
          member.checkInState = 'pending';
          member.responseMessage = 'Waiting for reply…';
          member.lastCheckAt = Date.now();
        });
      });
      others.forEach(function (member) {
        scheduleSimulatedResponse(member.id);
      });
      showToast('Circle pulse sent!');
    }

    function handleNudgeMember(memberId) {
      const outcome = mutateCircle(function (circle) {
        const member = circle.members.find(function (item) {
          return item.id === memberId;
        });
        if (!member) {
          return { toast: 'Friend not found.' };
        }
        const now = Date.now();
        if (member.lastNudgeAt && (now - member.lastNudgeAt < 10 * 60 * 1000)) {
          return { toast: 'You recently nudged ' + member.name + '.' };
        }
        member.lastNudgeAt = now;
        member.nudgeCount = (member.nudgeCount || 0) + 1;
        member.responseMessage = 'You sent a wave! Expect a reply soon.';
        addCircleActivity(circle, 'You sent a wave to ' + member.name + '.');
        return { toast: 'Wave sent to ' + member.name + '!' };
      });
      if (outcome && outcome.toast) {
        showToast(outcome.toast);
      }
    }

    function handleCheckInMember(memberId) {
      const outcome = mutateCircle(function (circle) {
        const member = circle.members.find(function (item) {
          return item.id === memberId;
        });
        if (!member) {
          return { toast: 'Friend not found.' };
        }
        if (member.checkInState === 'pending') {
          return { toast: member.name + ' is already replying.' };
        }
        member.checkInState = 'pending';
        member.responseMessage = 'Waiting for reply…';
        member.lastCheckAt = Date.now();
        addCircleActivity(circle, 'You asked ' + member.name + ' for a fasting pulse check.');
        return { toast: 'Pulse check sent to ' + member.name + '!', memberName: member.name };
      });
      if (outcome && outcome.toast) {
        showToast(outcome.toast);
      }
      if (outcome && outcome.memberName) {
        scheduleSimulatedResponse(memberId);
      }
    }

    function scheduleSimulatedResponse(memberId) {
      if (circleResponseTimers[memberId]) {
        clearTimeout(circleResponseTimers[memberId]);
      }
      const delay = randomBetween(CIRCLE_RESPONSE_DELAY.min, CIRCLE_RESPONSE_DELAY.max);
      circleResponseTimers[memberId] = setTimeout(function () {
        const response = mutateCircle(function (circle) {
          const member = circle.members.find(function (item) {
            return item.id === memberId;
          });
          if (!member || member.checkInState !== 'pending') {
            return { toast: null };
          }
          const outcome = pickCircleResponse(member);
          member.status = outcome.status || member.status;
          member.responseMessage = outcome.message;
          member.checkInState = 'idle';
          if (typeof outcome.hydrationMinutes === 'number') {
            member.lastHydrationMinutes = Math.max(0, Math.round(outcome.hydrationMinutes));
          }
          if (typeof outcome.hoursDelta === 'number') {
            member.hours = Math.max(0, Math.round((member.hours || 0) + outcome.hoursDelta));
          }
          member.lastResponseAt = Date.now();
          addCircleActivity(circle, member.name + ' ' + outcome.activity);
          return { toast: outcome.toast };
        });
        if (response && response.toast) {
          showToast(response.toast);
        }
        delete circleResponseTimers[memberId];
      }, delay);
    }

    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pickCircleResponse(member) {
      if (!Array.isArray(CIRCLE_RESPONSE_GENERATORS) || !CIRCLE_RESPONSE_GENERATORS.length) {
        return {
          status: member.status,
          message: member.name + ' is still on track.',
          activity: 'is staying focused.',
          toast: member.name + ' checked in!'
        };
      }
      const generator = CIRCLE_RESPONSE_GENERATORS[Math.floor(Math.random() * CIRCLE_RESPONSE_GENERATORS.length)];
      return generator(member);
    }

    function addCircleActivity(circle, message) {
      if (!circle.activity) {
        circle.activity = [];
      }
      circle.activity.push({
        id: 'act-' + Date.now() + '-' + Math.random().toString(16).slice(-4),
        message: message,
        timestamp: Date.now()
      });
      if (circle.activity.length > 25) {
        circle.activity = circle.activity.slice(circle.activity.length - 25);
      }
    }

    function syncCircleWithStatus(status) {
      if (!status) {
        return;
      }
      mutateCircle(function (circle) {
        let selfMember = circle.members.find(function (member) {
          return member.id === 'you';
        });
        if (!selfMember) {
          selfMember = normalizeMember({ id: 'you', name: 'You' }, 0);
          circle.members.push(selfMember);
        }
        const isFasting = status.status === 'fasting';
        selfMember.status = isFasting ? 'fasting' : 'planning';
        selfMember.hours = isFasting ? Math.max(0, Math.floor((status.elapsedMinutes || 0) / 60)) : 0;
        const hydrationMinutes = status.hydration && typeof status.hydration.lastDrinkMinutesAgo === 'number'
          ? Math.max(0, Math.round(status.hydration.lastDrinkMinutesAgo))
          : null;
        selfMember.lastHydrationMinutes = hydrationMinutes;
        selfMember.responseMessage = isFasting && status.phaseDetails
          ? 'Sharing: ' + status.phaseDetails.title + ' • ' + status.phaseDetails.range + '.'
          : isFasting
            ? 'Sharing: Fast in progress—hydrating mindfully.'
            : 'You are off fast right now. Circle sees when you restart.';
        selfMember.checkInState = 'idle';
        selfMember.streak = selfMember.streak || 0;
      });
    }

    function startLocalFast(timestamp) {
      const now = Date.now();
      const resolved = Math.min(timestamp || now, now);
      const profile = mutateLocalProfile(function (profile) {
        profile.startTimestamp = resolved;
        profile.hydration = profile.hydration || {};
        const interval = profile.hydration.intervalMinutes || profile.reminderInterval || DEFAULT_REMINDER_MINUTES;
        profile.hydration.intervalMinutes = interval;
        profile.hydration.lastDrinkTimestamp = resolved;
        profile.hydration.nextReminderMinutes = interval;
        profile.unlockedMilestones = [];
      });
      return calculateLocalStatus(profile);
    }

    function stopLocalFast() {
      const profile = mutateLocalProfile(function (profile) {
        profile.startTimestamp = null;
        profile.hydration = profile.hydration || {};
        profile.hydration.lastDrinkTimestamp = null;
        profile.hydration.nextReminderMinutes = null;
        profile.unlockedMilestones = [];
      });
      return calculateLocalStatus(profile);
    }

    function recordLocalDrink() {
      const profile = mutateLocalProfile(function (profile) {
        profile.hydration = profile.hydration || {};
        profile.hydration.lastDrinkTimestamp = Date.now();
      });
      return calculateLocalStatus(profile);
    }

    function setLocalReminderInterval(value) {
      let interval = parseInt(value, 10);
      if (isNaN(interval) || interval < 30) {
        interval = DEFAULT_REMINDER_MINUTES;
      }
      const profile = mutateLocalProfile(function (profile) {
        profile.reminderInterval = interval;
        profile.hydration = profile.hydration || {};
        profile.hydration.intervalMinutes = interval;
      });
      return calculateLocalStatus(profile);
    }

    function setLocalStartTime(timestamp) {
      const resolved = Math.min(timestamp, Date.now());
      const profile = mutateLocalProfile(function (profile) {
        profile.startTimestamp = resolved;
        profile.hydration = profile.hydration || {};
        if (!profile.hydration.intervalMinutes) {
          profile.hydration.intervalMinutes = profile.reminderInterval || DEFAULT_REMINDER_MINUTES;
        }
        if (!profile.hydration.lastDrinkTimestamp || profile.hydration.lastDrinkTimestamp < resolved) {
          profile.hydration.lastDrinkTimestamp = resolved;
        }
      });
      return calculateLocalStatus(profile);
    }

    function calculateLocalStatus(profile) {
      if (!supportsLocalStorage()) {
        return null;
      }
      const data = profile || loadLocalProfile();
      if (!data) {
        return null;
      }
      const now = Date.now();
      const start = data.startTimestamp || null;
      const elapsedMinutes = start ? Math.max(0, Math.floor((now - start) / 60000)) : 0;
      const elapsedHours = elapsedMinutes / 60;
      const timeline = getLocalTimeline();
      const phaseDetails = start ? findPhaseFromHours(elapsedHours, timeline) : null;
      const activeIndex = phaseDetails ? phaseDetails.index : -1;
      const intervalMinutes = data.hydration && data.hydration.intervalMinutes
        ? data.hydration.intervalMinutes
        : data.reminderInterval || DEFAULT_REMINDER_MINUTES;
      const lastDrink = data.hydration ? data.hydration.lastDrinkTimestamp : null;
      let nextReminderMinutes = null;
      if (start && intervalMinutes > 0) {
        const reference = lastDrink || start;
        const dueAt = reference + intervalMinutes * 60000;
        const deltaMinutes = Math.ceil((dueAt - now) / 60000);
        nextReminderMinutes = deltaMinutes > 0 ? deltaMinutes : 0;
      }
      const hydration = {
        intervalMinutes: intervalMinutes,
        lastDrinkTimestamp: lastDrink || null,
        lastDrinkMinutesAgo: lastDrink ? Math.floor((now - lastDrink) / 60000) : null,
        lastReminderTimestamp: data.hydration ? data.hydration.lastReminderTimestamp || null : null,
        nextReminderMinutes: nextReminderMinutes
      };
      return {
        status: start ? 'fasting' : 'not_fasting',
        startTimestamp: start,
        elapsedMinutes: elapsedMinutes,
        elapsedHours: elapsedHours,
        elapsedLabel: start ? formatDurationLabel(elapsedMinutes) : '0h 0m',
        phase: phaseDetails ? phaseDetails.title : null,
        phaseDetails: phaseDetails,
        activePhaseIndex: activeIndex,
        progressPercent: start ? Math.min(100, Math.round((elapsedHours / PROGRESS_TARGET_HOURS) * 100)) : 0,
        timeline: timeline,
        motivationalMessage: buildLocalMotivation(elapsedHours, phaseDetails),
        hydration: hydration
      };
    }

    function persistLocalProfileFromStatus(status) {
      if (!status || !supportsLocalStorage()) {
        return;
      }
      const profile = getOrCreateLocalProfile();
      profile.startTimestamp = status.startTimestamp || null;
      profile.lastKnownElapsedMinutes = status.elapsedMinutes;
      profile.reminderInterval = status.hydration && status.hydration.intervalMinutes
        ? status.hydration.intervalMinutes
        : profile.reminderInterval || DEFAULT_REMINDER_MINUTES;
      profile.hydration = profile.hydration || {};
      if (status.hydration) {
        profile.hydration.intervalMinutes = status.hydration.intervalMinutes;
        profile.hydration.lastDrinkTimestamp = status.hydration.lastDrinkTimestamp || null;
        profile.hydration.lastReminderTimestamp = status.hydration.lastReminderTimestamp || null;
        profile.hydration.nextReminderMinutes = status.hydration.nextReminderMinutes;
      }
      if (status.status !== 'fasting') {
        profile.unlockedMilestones = [];
      } else if (!Array.isArray(profile.unlockedMilestones)) {
        profile.unlockedMilestones = [];
      }
      profile.lastSynced = Date.now();
      saveLocalProfile(profile);
    }

    function getLocalTimeline() {
      return LOCAL_TIMELINE;
    }

    function findPhaseFromHours(hours, timeline) {
      if (!timeline || !timeline.length) {
        return null;
      }
      for (let i = 0; i < timeline.length; i++) {
        const phase = timeline[i];
        if (phase.endHours === null) {
          if (hours >= phase.startHours) {
            return Object.assign({ index: i }, phase);
          }
        } else if (hours >= phase.startHours && hours < phase.endHours) {
          return Object.assign({ index: i }, phase);
        }
      }
      const lastIndex = timeline.length - 1;
      return Object.assign({ index: lastIndex }, timeline[lastIndex]);
    }

    function buildLocalMotivation(hours, phaseDetails) {
      const baseMessages = [
        'Every mindful sip powers your focus.',
        'Smile—your steady rhythm is working.',
        'Hydration keeps your energy silky smooth.',
        'Gentle movement keeps the momentum flowing.',
        'Celebrate this moment—consistency is your superpower.',
        'Kind self-talk keeps the journey joyful.'
      ];
      const index = Math.floor(hours) % baseMessages.length;
      let message = baseMessages[index];
      if (!phaseDetails) {
        return 'Welcome to HydraFast—press “Start Fast” to begin your journey when you feel ready.';
      }
      if (phaseDetails.focus) {
        message = phaseDetails.focus + ' ' + message;
      }
      return message;
    }

    function formatDurationLabel(totalMinutes) {
      const minutes = Math.max(0, Math.floor(totalMinutes));
      const hours = Math.floor(minutes / 60);
      const remainder = minutes % 60;
      return hours + 'h ' + remainder + 'm';
    }

    function getOrCreateLocalProfile() {
      const existing = loadLocalProfile();
      if (existing) {
        if (!existing.hydration) {
          existing.hydration = {};
        }
        if (!Array.isArray(existing.unlockedMilestones)) {
          existing.unlockedMilestones = [];
        }
        return existing;
      }
      return {
        startTimestamp: null,
        hydration: {
          intervalMinutes: DEFAULT_REMINDER_MINUTES,
          lastDrinkTimestamp: null,
          lastReminderTimestamp: null,
          nextReminderMinutes: null
        },
        reminderInterval: DEFAULT_REMINDER_MINUTES,
        unlockedMilestones: []
      };
    }

    function mutateLocalProfile(mutator) {
      const profile = getOrCreateLocalProfile();
      mutator(profile);
      if (!Array.isArray(profile.unlockedMilestones)) {
        profile.unlockedMilestones = [];
      }
      profile.hydration = profile.hydration || {};
      saveLocalProfile(profile);
      return profile;
    }

    function loadLocalProfile() {
      if (!supportsLocalStorage()) {
        return null;
      }
      const raw = localStorage.getItem(LOCAL_PROFILE_KEY);
      if (!raw) {
        return null;
      }
      try {
        return JSON.parse(raw);
      } catch (err) {
        return null;
      }
    }

    function saveLocalProfile(profile) {
      if (!supportsLocalStorage()) {
        return;
      }
      try {
        localStorage.setItem(LOCAL_PROFILE_KEY, JSON.stringify(profile));
      } catch (err) {
        // Ignore storage write failures (quota, private mode, etc.)
      }
    }

    function supportsLocalStorage() {
      try {
        return typeof localStorage !== 'undefined' && localStorage !== null;
      } catch (err) {
        return false;
      }
    }

    function hasAppsScript() {
      return typeof google !== 'undefined' && google.script && google.script.run;
    }
  </script>
</body>
</html>
